#!/usr/bin/env bash

xauth=@xauth@
xinit=@xinit@
xserver=@xserver@
xterm=@xterm@
deallocvt=@deallocvt@
defaultclient="$xterm"
defaultserver="$xserver"
serverargs=""
xserverauthfile="$HOME/.serverauth.$$"

set -u

unset SESSION_MANAGER

userclientrc="$HOME/.xinitrc"
[ -f "${XINITRC-}" ] && userclientrc="${XINITRC}"
sysclientrc=/etc/X11/xinit/xinitrc

userserverrc="$HOME/.xserverrc"
[ -f "${XSERVERRC-}" ] && userserverrc="${XSERVERRC}"
sysserverrc=/etc/X11/xinit/xserverrc

if [ -f "$userclientrc" ]; then
    client="$userclientrc"
elif [ -f "$sysclientrc" ]; then
    client="$sysclientrc"
else
    client="$defaultclient"
fi

if [ -f "$userserverrc" ]; then
    server="$userserverrc"
elif [ -f "$sysserverrc" ]; then
    server="$sysserverrc"
else
    server="$defaultserver"
fi

# Start the server on current tty to ensure session is recognized as active.
# "https://bugzilla.redhat.com/show_bug.cgi?id=806491"
tty=$(tty)
if ! expr "$tty" : '/dev/tty[0-9][0-9]*$' > /dev/null; then
    echo "Expected a virtual terminal" >&2
    exit 1
fi
tty_num="${tty#/dev/tty}"
display=":$tty_num"
serverargs="$serverargs vt$tty_num -keeptty"

if [ "${XAUTHORITY-}" = "" ]; then
    XAUTHORITY="$HOME/.Xauthority"
    export XAUTHORITY
fi

mcookie=$(dd if=/dev/urandom bs=16 count=1 2>/dev/null | hexdump -e \"%08x\")
if [ "$mcookie" = "" ]; then
    echo "Couldn't create cookie" >&2
    exit 1
fi

# Set up server auth.
dummy=0
trap "rm -f '$xserverauthfile'" HUP INT QUIT ILL TRAP BUS TERM
"$xauth" -q -f "$xserverauthfile" add :$dummy MIT-MAGIC-COOKIE-1 $mcookie
serverargs=${serverargs}" -auth "${xserverauthfile}

# Set up client auth.
removelist=
hostname="$(uname -n)"
for displayname in $display $hostname$display; do
    authcookie=$(
        "$xauth" list "$displayname" |
        sed -n 's/.*'"$displayname"'[[:space:]*].*[[:space:]*]//p' 2>/dev/null
    )
    if [ "z${authcookie}" = "z" ] ; then
        "$xauth" -q add $displayname MIT-MAGIC-COOKIE-1 $mcookie
        removelist="$displayname $removelist"
    else
        dummy=$(($dummy+1));
        "$xauth" -q -f "$xserverauthfile" add :$dummy MIT-MAGIC-COOKIE-1 $authcookie
    fi
done

"$xinit" "$client" -- "$server" $display $serverargs
retval=$?

if [ "$removelist" != "" ]; then
    "$xauth" remove $removelist
fi
rm -f "$xserverauthfile"

"$deallocvt"

exit $retval
